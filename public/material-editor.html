<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material Editor (UE5 Replica)</title>

    <!-- Prevent caching during development -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Google Font (Inter) - Matches UE5 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Import Map for Three.js (required for 3D preview) -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <!-- FontAwesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />

    <!-- External Stylesheet -->
    <link rel="stylesheet" href="material-editor.css" />
  </head>

  <body>
    <div id="app-container" class="material-editor">
      <!-- ============================================= -->
      <!-- TOP MENU BAR -->
      <!-- ============================================= -->
      <div id="menubar" class="menubar">
        <div class="menu-left">
          <img
            src="assets/icons/ue-logo.svg"
            alt="UE Logo"
            class="ue-logo-icon"
          />
          <div class="menu-item" data-menu="file">File</div>
          <div class="menu-item" data-menu="edit">Edit</div>
          <div class="menu-item" data-menu="asset">Asset</div>
          <div class="menu-item" data-menu="window">Window</div>
          <div class="menu-item" data-menu="help">Help</div>
        </div>
        <div class="menu-right">
          <div class="window-controls">
            <i class="fas fa-minus"></i>
            <i class="far fa-square"></i>
            <i class="fas fa-times"></i>
          </div>
        </div>
      </div>

      <!-- ============================================= -->
      <!-- TAB BAR -->
      <!-- ============================================= -->
      <div id="tabbar" class="tabbar">
        <div class="tab active">
          <i
            class="fas fa-circle"
            style="color: #ffa500; margin-right: 6px; font-size: 8px"
          ></i>
          <span>M_NewMaterial*</span>
          <i class="fas fa-times tab-close"></i>
        </div>
        <div class="tab-spacer"></div>
      </div>

      <!-- ============================================= -->
      <!-- TOP TOOLBAR -->
      <!-- ============================================= -->
      <div id="toolbar" class="panel toolbar">
        <!-- Save/Apply Group -->
        <div class="toolbar-group">
          <button id="save-btn" class="toolbar-btn" title="Save (Ctrl+S)">
            <i class="fas fa-save"></i>
            <span>Save</span>
          </button>
          <button
            id="apply-btn"
            class="toolbar-btn btn-primary"
            title="Apply Changes"
          >
            <i class="fas fa-check"></i>
            <span>Apply</span>
          </button>
        </div>

        <!-- Navigation Group -->
        <div class="toolbar-group">
          <button id="search-btn" class="toolbar-btn" title="Search Graph">
            <i class="fas fa-search"></i>
          </button>
          <button
            id="home-btn"
            class="toolbar-btn"
            title="Home (Focus Main Node)"
          >
            <i class="fas fa-home"></i>
          </button>
          <button
            id="hierarchy-btn"
            class="toolbar-btn"
            title="Show Material Instances"
          >
            <i class="fas fa-sitemap"></i>
          </button>
        </div>

        <!-- Toggle Group -->
        <div class="toolbar-group">
          <button
            id="live-update-btn"
            class="toolbar-btn toggle-btn active"
            title="Live Preview Update"
          >
            <i class="fas fa-sync-alt"></i>
            <span>Live</span>
          </button>
          <button
            id="clean-graph-btn"
            class="toolbar-btn"
            title="Remove Orphan Nodes"
          >
            <i class="fas fa-broom"></i>
          </button>
        </div>

        <!-- Zoom Display -->
        <span id="toolbar-status" class="toolbar-status">
          Zoom: <span id="zoom-readout">100%</span>
        </span>

        <!-- Right Side Tools -->
        <div class="toolbar-group" style="margin-left: auto">
          <button id="undo-btn" class="toolbar-btn" title="Undo (Ctrl+Z)">
            <i class="fas fa-undo"></i>
          </button>
          <button id="redo-btn" class="toolbar-btn" title="Redo (Ctrl+Y)">
            <i class="fas fa-redo"></i>
          </button>
        </div>

        <div class="toolbar-group">
          <button id="help-btn" class="toolbar-btn" title="Help (F1)">
            <i class="fas fa-question-circle"></i>
          </button>
        </div>
      </div>

      <!-- ============================================= -->
      <!-- MAIN CONTENT AREA -->
      <!-- ============================================= -->
      <div id="main-content">
        <!-- LEFT COLUMN: Viewport + Palette -->
        <div id="left-column" class="panel-column">
          <!-- 3D VIEWPORT PANEL -->
          <div id="viewport-panel" class="panel">
            <div class="panel-header">
              <span>Viewport</span>
              <div class="panel-header-tools">
                <!-- Environment Preset Dropdown -->
                <select
                  id="viewport-env-select"
                  class="panel-select"
                  title="Environment Preset"
                >
                  <option value="studio">Studio</option>
                  <option value="outdoor">Outdoor</option>
                  <option value="night">Night</option>
                </select>
                <!-- View Mode Dropdown -->
                <select
                  id="viewport-view-mode"
                  class="panel-select"
                  title="View Mode"
                >
                  <option value="lit">Lit</option>
                  <option value="unlit">Unlit</option>
                  <option value="wireframe">Wireframe</option>
                </select>
                <!-- Mesh Selection -->
                <select
                  id="viewport-mesh-select"
                  class="panel-select"
                  title="Preview Mesh"
                >
                  <option value="sphere">Sphere</option>
                  <option value="cylinder">Cylinder</option>
                  <option value="plane">Plane</option>
                  <option value="cube">Cube</option>
                </select>
                <!-- FOV Control -->
                <label class="fov-label" title="Field of View">
                  FOV
                  <input
                    type="range"
                    id="viewport-fov"
                    min="30"
                    max="90"
                    value="45"
                    class="fov-slider"
                  />
                </label>
                <!-- Exposure Control -->
                <label class="exposure-label" title="Exposure (EV)">
                  EV
                  <input
                    type="range"
                    id="viewport-exposure"
                    min="-3"
                    max="3"
                    value="0"
                    step="0.1"
                    class="exposure-slider"
                  />
                </label>
                <!-- Realtime Toggle -->
                <button
                  id="viewport-realtime-btn"
                  class="panel-tool active"
                  title="Toggle Realtime Rendering"
                >
                  ‚è±Ô∏è
                </button>
                <!-- Floor Toggle -->
                <button
                  id="viewport-floor-btn"
                  class="panel-tool"
                  title="Toggle Floor Plane"
                >
                  Floor
                </button>
                <!-- Show Flags -->
                <button
                  id="viewport-grid-btn"
                  class="panel-tool active"
                  title="Toggle Grid"
                >
                  Grid
                </button>
                <!-- Tone Mapper Toggle -->
                <button
                  id="viewport-tonemapper-btn"
                  class="panel-tool active"
                  title="Toggle Tone Mapping"
                >
                  TM
                </button>
              </div>
            </div>
            <div id="viewport-container" class="panel-content viewport-content">
              <canvas id="viewport-canvas"></canvas>
              <div id="viewport-overlay">
                <span class="viewport-hint"
                  >Hold Shift + Drag to rotate light</span
                >
              </div>
            </div>
          </div>

          <div class="resizer-horizontal" id="resizer-viewport"></div>

          <!-- STATS PANEL -->
          <div id="stats-panel" class="panel">
            <div class="panel-header">
              <span>üìä Stats</span>
            </div>
            <div id="stats-content" class="panel-content">
              <div class="stats-grid">
                <div class="stat-row">
                  <span class="stat-label">Nodes</span>
                  <span class="stat-value">0</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Texture Samplers</span>
                  <span class="stat-value">0 / 16</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Est. Instructions</span>
                  <span class="stat-value">~0</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Budget</span>
                  <span class="stat-value">üü¢ Low</span>
                </div>
              </div>
            </div>
          </div>

          <div class="resizer-horizontal" id="resizer-stats"></div>

          <!-- PALETTE PANEL -->
          <div id="palette-panel" class="panel">
            <div class="panel-header">
              <span>Palette</span>
            </div>
            <div class="panel-toolbar">
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input
                  type="text"
                  id="palette-filter"
                  placeholder="Search nodes..."
                />
              </div>
            </div>
            <div id="palette-content" class="panel-content tree-view">
              <!-- Dynamic content generated by JS -->
            </div>
          </div>
        </div>

        <div class="resizer-vertical" id="resizer-left"></div>

        <!-- CENTER: Material Graph Canvas -->
        <div id="graph-panel" class="panel">
          <canvas id="graph-canvas"></canvas>
          <svg id="graph-svg" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <!-- Gradient definitions for wires -->
              <linearGradient
                id="wire-gradient-float"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop offset="0%" style="stop-color: #9e9e9e" />
                <stop offset="100%" style="stop-color: #9e9e9e" />
              </linearGradient>
              <linearGradient
                id="wire-gradient-float2"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop offset="0%" style="stop-color: #4caf50" />
                <stop offset="100%" style="stop-color: #4caf50" />
              </linearGradient>
              <linearGradient
                id="wire-gradient-float3"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop offset="0%" style="stop-color: #ffc107" />
                <stop offset="100%" style="stop-color: #ffc107" />
              </linearGradient>
              <linearGradient
                id="wire-gradient-float4"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop offset="0%" style="stop-color: #e91e63" />
                <stop offset="100%" style="stop-color: #e91e63" />
              </linearGradient>
              <linearGradient
                id="wire-gradient-texture"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop offset="0%" style="stop-color: #2196f3" />
                <stop offset="100%" style="stop-color: #2196f3" />
              </linearGradient>
            </defs>
            <g id="wire-group">
              <path
                id="ghost-wire"
                class="wire ghost"
                style="pointer-events: none; display: none"
              ></path>
            </g>
          </svg>
          <div id="nodes-container">
            <!-- Nodes generated by JS -->
          </div>
          <div id="selection-marquee" style="display: none"></div>
        </div>

        <div class="resizer-vertical" id="resizer-right"></div>

        <!-- RIGHT COLUMN: Details Panel -->
        <div id="right-column" class="panel-column">
          <!-- DETAILS PANEL -->
          <div id="details-panel" class="panel">
            <div class="panel-header">
              <span>Details</span>
            </div>
            <div class="panel-toolbar">
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input
                  type="text"
                  id="details-filter"
                  placeholder="Search properties..."
                />
              </div>
            </div>
            <div id="details-content" class="panel-content">
              <!-- Material Properties when nothing selected -->
              <div id="material-properties">
                <div class="property-category">
                  <div class="category-header">
                    <i class="fas fa-chevron-down"></i>
                    <span>Material</span>
                  </div>
                  <div class="category-content">
                    <div class="property-row">
                      <label>Material Domain</label>
                      <select id="material-domain">
                        <option value="Surface">Surface</option>
                        <option value="DeferredDecal">Deferred Decal</option>
                        <option value="LightFunction">Light Function</option>
                        <option value="Volume">Volume</option>
                        <option value="PostProcess">Post Process</option>
                        <option value="UI">User Interface</option>
                        <option value="VirtualTexture">Virtual Texture</option>
                      </select>
                    </div>
                    <div class="property-row">
                      <label>Blend Mode</label>
                      <select id="blend-mode">
                        <option value="Opaque">Opaque</option>
                        <option value="Masked">Masked</option>
                        <option value="Translucent">Translucent</option>
                        <option value="Additive">Additive</option>
                        <option value="Modulate">Modulate</option>
                        <option value="AlphaComposite">
                          Alpha Composite (Premultiplied)
                        </option>
                        <option value="AlphaHoldout">Alpha Holdout</option>
                      </select>
                    </div>
                    <div
                      class="property-row"
                      id="opacity-clip-row"
                      style="display: none"
                    >
                      <label>Opacity Mask Clip Value</label>
                      <input
                        type="number"
                        id="opacity-mask-clip"
                        value="0.5"
                        min="0"
                        max="1"
                        step="0.01"
                      />
                    </div>
                    <div class="property-row">
                      <label>Shading Model</label>
                      <select id="shading-model">
                        <option value="DefaultLit">Default Lit</option>
                        <option value="Unlit">Unlit</option>
                        <option value="Subsurface">Subsurface</option>
                        <option value="PreintegratedSkin">
                          Preintegrated Skin
                        </option>
                        <option value="ClearCoat">Clear Coat</option>
                        <option value="SubsurfaceProfile">
                          Subsurface Profile
                        </option>
                        <option value="TwoSidedFoliage">
                          Two Sided Foliage
                        </option>
                        <option value="Hair">Hair</option>
                        <option value="Cloth">Cloth</option>
                        <option value="Eye">Eye</option>
                        <option value="SingleLayerWater">
                          Single Layer Water
                        </option>
                        <option value="ThinTranslucent">
                          Thin Translucent
                        </option>
                      </select>
                    </div>
                    <div class="property-row">
                      <label>Two Sided</label>
                      <input
                        type="checkbox"
                        id="two-sided"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Dithered LOD Transition</label>
                      <input
                        type="checkbox"
                        id="dithered-lod"
                        class="ue5-checkbox"
                      />
                    </div>
                  </div>
                </div>

                <div class="property-category collapsed">
                  <div class="category-header">
                    <i class="fas fa-chevron-right"></i>
                    <span>Translucency</span>
                  </div>
                  <div class="category-content">
                    <div class="property-row">
                      <label>Lighting Mode</label>
                      <select id="translucency-lighting">
                        <option value="VolumetricNonDirectional">
                          Volumetric NonDirectional
                        </option>
                        <option value="VolumetricDirectional">
                          Volumetric Directional
                        </option>
                        <option value="VolumetricPerVertexNonDirectional">
                          Volumetric PerVertex NonDirectional
                        </option>
                        <option value="VolumetricPerVertexDirectional">
                          Volumetric PerVertex Directional
                        </option>
                        <option value="SurfaceForwardShading">
                          Surface Forward Shading
                        </option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="property-category collapsed">
                  <div class="category-header">
                    <i class="fas fa-chevron-right"></i>
                    <span>Physical Material</span>
                  </div>
                  <div class="category-content">
                    <div class="property-row">
                      <label>Phys Material Override</label>
                      <select id="phys-material">
                        <option value="None">None</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="property-category collapsed">
                  <div class="category-header">
                    <i class="fas fa-chevron-right"></i>
                    <span>Usage</span>
                  </div>
                  <div class="category-content">
                    <div class="property-row">
                      <label>Used with Skeletal Mesh</label>
                      <input
                        type="checkbox"
                        id="usage-skeletal"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Used with Particle Sprites</label>
                      <input
                        type="checkbox"
                        id="usage-particles"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Used with Niagara Sprites</label>
                      <input
                        type="checkbox"
                        id="usage-niagara"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Used with Spline Mesh</label>
                      <input
                        type="checkbox"
                        id="usage-spline"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Used with Instanced Static Mesh</label>
                      <input
                        type="checkbox"
                        id="usage-instanced"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Used with Geometry Cache</label>
                      <input
                        type="checkbox"
                        id="usage-geocache"
                        class="ue5-checkbox"
                      />
                    </div>
                    <div class="property-row">
                      <label>Used with Virtual Heightfield Mesh</label>
                      <input
                        type="checkbox"
                        id="usage-heightfield"
                        class="ue5-checkbox"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Node Properties (shown when a node is selected) -->
              <div id="node-properties" style="display: none">
                <!-- Dynamically generated -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================= -->
      <!-- BOTTOM STATUS BAR -->
      <!-- ============================================= -->
      <div id="status-bar" class="panel status-bar">
        <div class="status-left">
          <span id="status-message">Ready</span>
        </div>
        <div class="status-right">
          <span id="node-count">Nodes: 1</span>
          <span class="status-divider">|</span>
          <span id="connection-count">Connections: 0</span>
        </div>
      </div>
    </div>

    <!-- ============================================= -->
    <!-- ACTION MENU (Right-click context menu) -->
    <!-- ============================================= -->
    <div id="action-menu" class="action-menu" style="display: none">
      <div class="action-menu-header">
        <input
          type="text"
          id="action-menu-search"
          placeholder="Search..."
          autocomplete="off"
        />
      </div>
      <div id="action-menu-list" class="action-menu-list">
        <!-- Dynamic content generated by JS -->
      </div>
    </div>

    <!-- ============================================= -->
    <!-- CONTEXT MENU -->
    <!-- ============================================= -->
    <div id="context-menu" class="context-menu" style="display: none">
      <!-- Dynamic content generated by JS -->
    </div>

    <!-- ============================================= -->
    <!-- HLSL CODE VIEWER MODAL -->
    <!-- ============================================= -->
    <div id="hlsl-modal" class="modal" style="display: none">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>Generated HLSL Code</h2>
          <div class="modal-tabs">
            <button class="modal-tab active" data-target="hlsl-vertex">
              Vertex Shader
            </button>
            <button class="modal-tab" data-target="hlsl-pixel">
              Pixel Shader
            </button>
          </div>
        </div>
        <div id="hlsl-vertex" class="code-viewer">
          <pre><code class="language-hlsl">// Vertex Shader Code
// Click "Apply" to generate shader from current graph

void MainVS(
    in float4 Position : ATTRIBUTE0,
    in float3 Normal : ATTRIBUTE1,
    in float2 TexCoord : ATTRIBUTE2,
    out float4 OutPosition : SV_POSITION,
    out float3 OutWorldNormal : TEXCOORD0,
    out float2 OutUV : TEXCOORD1
)
{
    OutPosition = mul(Position, WorldViewProjection);
    OutWorldNormal = mul(Normal, (float3x3)WorldMatrix);
    OutUV = TexCoord;
}</code></pre>
        </div>
        <div id="hlsl-pixel" class="code-viewer" style="display: none">
          <pre><code class="language-hlsl">// Pixel Shader Code
// Generated from Material Graph

struct MaterialOutput {
    float3 BaseColor;
    float Metallic;
    float Specular;
    float Roughness;
    float3 EmissiveColor;
    float3 Normal;
    float Opacity;
};

MaterialOutput EvaluateMaterial(float2 UV, float3 WorldNormal)
{
    MaterialOutput Output;
    
    // Connect nodes to populate these values
    Output.BaseColor = float3(1.0, 1.0, 1.0);
    Output.Metallic = 0.0;
    Output.Specular = 0.5;
    Output.Roughness = 0.5;
    Output.EmissiveColor = float3(0.0, 0.0, 0.0);
    Output.Normal = WorldNormal;
    Output.Opacity = 1.0;
    
    return Output;
}</code></pre>
        </div>
        <div class="modal-footer">
          <span class="code-stats"
            >Instructions: <span id="hlsl-instruction-count">0</span> |
            Samplers: <span id="hlsl-sampler-count">0</span></span
          >
          <button id="hlsl-copy-btn" class="btn-action">
            Copy to Clipboard
          </button>
          <button id="hlsl-modal-close" class="btn-close">Close</button>
        </div>
      </div>
    </div>

    <!-- ============================================= -->
    <!-- HELP MODAL -->
    <!-- ============================================= -->
    <div id="help-modal" class="modal" style="display: none">
      <div class="modal-content">
        <h2>Material Editor Controls</h2>
        <div class="help-section">
          <h3>Navigation</h3>
          <ul>
            <li><strong>Pan:</strong> Middle Mouse or RMB Drag</li>
            <li><strong>Zoom:</strong> Mouse Wheel</li>
            <li><strong>Home:</strong> Focus on Main Material Node</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Node Operations</h3>
          <ul>
            <li><strong>Add Node:</strong> Right-click on graph</li>
            <li><strong>Select:</strong> Left-click</li>
            <li><strong>Multi-Select:</strong> Ctrl + click or marquee drag</li>
            <li><strong>Delete:</strong> Delete or Backspace key</li>
            <li><strong>Duplicate:</strong> Ctrl + W</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Spawn Hotkeys</h3>
          <ul>
            <li><strong>1:</strong> Constant (Float)</li>
            <li><strong>2:</strong> Constant2Vector</li>
            <li><strong>3:</strong> Constant3Vector (Color)</li>
            <li><strong>T:</strong> Texture Sample</li>
            <li><strong>M:</strong> Multiply</li>
            <li><strong>A:</strong> Add</li>
            <li><strong>L:</strong> Lerp (Linear Interpolate)</li>
            <li><strong>S:</strong> Scalar Parameter</li>
            <li><strong>V:</strong> Vector Parameter</li>
            <li><strong>C:</strong> Comment</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Wire Operations</h3>
          <ul>
            <li><strong>Connect:</strong> Drag from output to input pin</li>
            <li><strong>Break Link:</strong> Alt + click on pin</li>
            <li><strong>Reroute:</strong> Double-click on wire</li>
          </ul>
        </div>
        <button id="help-modal-close" class="btn-close">Close</button>
      </div>
    </div>

    <!-- ============================================= -->
    <!-- SCRIPTS -->
    <!-- ============================================= -->
    <script type="module" src="../material/material-app.js"></script>
  </body>
</html>
